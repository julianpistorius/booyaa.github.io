<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Code generation scripts in PL/SQL</title>
<link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-3dkvEK0WLHRJ7/Csr0BZjAWxERc5WH7bdeUya2aXxdU= sha512-+L4yy6FRcDGbXJ9mPG8MT/3UCDzwR9gPeyFNMCtInsol++5m3bk2bXWKdZjvybmohrAsn3Ua5x8gfLnbE1YkOg==" crossorigin="anonymous">
<link rel="stylesheet" href="//writ.cmcenroe.me/1.0.2/writ.min.css">
<link rel="stylesheet" href="/style.css" type="text/css" media="all" />
<link rel="alternate" href="/rss.xml" type="application/rss+xml" title="RSS" />
<meta name="author" content="Mark Sta Ana">
<meta name="description" content="Personal website of Mark Sta Ana, aged 7 3/4."/>
<meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" /> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101141559-1', 'auto');
  ga('send', 'pageview');

</script>

  </head>
<body data-route=>
  <nav class="menu">
  <a class="menu-item " href="/about/">booyaa</a>
  <a class="menu-item " href="/">blog</a>
  <a class="menu-item" href="/search/">search</a>
  <a class="menu-item" href="/archive/">archive</a>
  <a class="menu-item icon" href="http://github.com/booyaa"><i class="fa fa-github"></i></a>
  <a class="menu-item icon" href="http://twitter.com/booyaa"><i class="fa fa-twitter"></i></a>
  <a class="menu-item icon" href="/rss.xml"><i class="fa fa-rss"></i></a>
  <hr>
</nav>

  <main>
    <article>
      <h1>Code generation scripts in PL/SQL</h1>
       
      
      
      								
          
    	 

			<time pubdate="pubdate">May 10, 2017 - Reading time: 2 minutes.</time><br />
      
      <h2>Flattening XML paths</h2>
<p>The table <code>elephant_castle</code> has a <code>XMLTYPE</code> column <code>details</code> that we want to
get a list of distinct node paths.</p>
<pre><code class="language-sql">WITH node_list AS (
    SELECT
        x.*
    FROM
        elephant_castle ec
        CROSS JOIN XMLTABLE ( 
'declare function local:path-to-node( $nodes as node()* ) as xs:string* { 
    $nodes/string-join(ancestor-or-self::*/name(.),''/'') 
}
;for $i in $doc//*
    let $node_path := local:path-to-node($i)  
    (: still don''t have a clue how this func works :)
    let $node_value := $i/text()
    where string-length($node_value) &gt; 0        
    (: how to exclude nodes without values :)

    return &lt;data&gt;
                &lt;path&gt;{$node_path}&lt;/path&gt;
                &lt;value&gt;{$node_value}&lt;/value&gt;
            &lt;/data&gt;'
                PASSING ec.details AS &quot;doc&quot; COLUMNS
                    node_path VARCHAR2(4000) PATH 'path',
                    node_value VARCHAR2(4000) PATH 'value' /* debugging */
            ) x
) SELECT distinct nl.node_path
FROM
    node_list nl;    
</code></pre>
<h2>Generate a query that combines existing fields with newly flatten XML paths</h2>
<p>This script allows you to apply boiler plate (fields from the existing table
using the data dictionary) and then make call out to another sqlplus script
that contains table specific mappings. The call out script is assumed to be
called <code>TableName.sql</code>.</p>
<pre><code class="language-plsql">REM Suppress all headings, page breaks, titles
SET PAGESIZE 0
REM Do not list the text of a command before and after replacing substitution 
REM variables with values
SET VERIFY OFF
REM  Do not display the number of records returned (when rows &gt;= n )
SET FEEDBACK OFF

CLEAR SCREEN

DEFINE TableName=STANDINGORDER
DEFINE TableAlias=so
DEFINE TableSchema=BPHADMIN

/*******************************************************************************
** Generate existing column list, excluding XMLTYPE, BLOB and CLOB types.
*******************************************************************************/
WITH column_list AS (
    SELECT
        column_id,
        column_name
    FROM
        all_tab_cols
    WHERE
        owner = '&amp;TableSchema'
    AND
        table_name = '&amp;TableName'
    AND
        data_type NOT IN (
            'XMLTYPE','BLOB','CLOB'
        )
    ORDER BY column_id
) SELECT
    CASE column_id  
        WHEN 1 THEN 'SELECT &amp;TableAlias'|| '.' || column_name
        ELSE ',&amp;TableAlias'|| '.' || column_name
    END as sql
FROM
    column_list;

/*******************************************************************************
** Call out script with custom XML flattening logic (usually field name tweaks)
*******************************************************************************/
@&amp;TableName

/*******************************************************************************
** Add &quot;FROM&quot; statement
*******************************************************************************/
PROMPT FROM &amp;TableName &amp;TableAlias;;
</code></pre>

    </article>
    <br /><br />
    <a href="https://twitter.com/share" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </main>
  <footer>
  <hr>
  <p>
    <a href="/license/">CC BY-SA 4.0 / MIT</a>
    -
    <a href="https://github.com/cobalt-org/cobalt.rs">Built with Cobalt</a>
  </p>
  <br>
</footer>

</body>
</html>
