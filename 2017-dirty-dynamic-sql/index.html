<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Dirty Dynamic SQL</title>
<link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-3dkvEK0WLHRJ7/Csr0BZjAWxERc5WH7bdeUya2aXxdU= sha512-+L4yy6FRcDGbXJ9mPG8MT/3UCDzwR9gPeyFNMCtInsol++5m3bk2bXWKdZjvybmohrAsn3Ua5x8gfLnbE1YkOg==" crossorigin="anonymous">
<link rel="stylesheet" href="//writ.cmcenroe.me/1.0.2/writ.min.css">
<link rel="stylesheet" href="/style.css" type="text/css" media="all" />
<link rel="alternate" href="/rss.xml" type="application/rss+xml" title="RSS" />
<meta name="author" content="Mark Sta Ana">
<meta name="description" content="Personal website of Mark Sta Ana, aged 7 3/4."/>
<meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" /> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101141559-1', 'auto');
  ga('send', 'pageview');

</script>

  </head>
<body data-route=>
  <nav class="menu">
  <a class="menu-item " href="/about/">booyaa</a>
  <a class="menu-item " href="/">blog</a>
  <a class="menu-item" href="/search/">search</a>
  <a class="menu-item" href="/archive/">archive</a>
  <a class="menu-item icon" href="http://github.com/booyaa"><i class="fa fa-github"></i></a>
  <a class="menu-item icon" href="http://twitter.com/booyaa"><i class="fa fa-twitter"></i></a>
  <a class="menu-item icon" href="/rss.xml"><i class="fa fa-rss"></i></a>
  <hr>
</nav>

  <main>
    <article>
      <h1>Dirty Dynamic SQL</h1>
       
      
      
      								
          
    	 

			<time pubdate="pubdate">Jul 01, 2017 - Reading time: 2 minutes.</time><br />
      
      <p>Not all dynamic sql is strictly for immediate execution, nor is it dirty (I
needed aninteresting title). I learnt this tricks from my friend at work, he's
a big believer of using sql to code generate more sql.</p>
<h2>Altering column length</h2>
<p>You'll still get an error when running the generated sql if you try to shrink a column.</p>
<pre><code class="language-sql">SELECT 'ALTER TABLE ' || table_name || ' MODIFY ' || column_name || ' VARCHAR2(' || CASE column_name  WHEN 'FOO' THEN '10'  ELSE '20' END || ');' AS sql
  FROM user_tab_columns 
 WHERE column_name IN ( 'FOO','BAR')
   AND table_name IN (SELECT table_name FROM user_tables)   
   AND NOT regexp_like(table_name, '_(NEW|BAK)$') -- exclude backups
</code></pre>
<h2>Inserting (hurr) output from dynamic sql</h2>
<p>Normally you'd expect to get away with using something like <code>SELECT blah INTO v_foo</code>, but with dynamic sql you need place the <code>INTO</code> in the <code>EXECUTE IMMEDIATE</code> statement.</p>
<pre><code class="language-plsql">SET SERVEROUTPUT ON
DECLARE
  v_sql VARCHAR2(8000);
  v_count NUMBER;
  CURSOR c_tables
      IS
  SELECT table_name
    FROM user_tables;
BEGIN
  FOR rec in c_tables
  LOOP
    v_sql := 'SELECT count(*) FROM ' || rec.table_name;
    EXECUTE IMMEDIATE v_sql INTO v_count;
    
    DBMS_OUTPUT.put_line(rec.table_name || ' has ' || v_count);
  END LOOP;
END;
/
</code></pre>
<p>tags: rowcount , row , count</p>
<h2>Using substution variables</h2>
<pre><code class="language-sql">clear screen
set serveroutput on
declare
  cursor c_tables is select table_name from user_tables;
  v_data VARCHAR2(2000);
  v_sql VARCHAR2(2000);
  v_stuff VARCHAR2(50) := '&amp;1'; -- try entering MAX(DATADATE) or COUNT(*) 
begin
  for rec in c_tables
  loop
    v_sql := 'SELECT TO_CHAR(' || v_stuff || ') FROM ' || rec.table_name;
    
    begin
      execute immediate v_sql into v_data;
      dbms_output.put_line(rec.table_name || ': ' || v_data);
    
    exception
      when others then
        dbms_output.put_line('failed to run: ' || v_sql);
        raise;
    end;
    end case;
  end loop;
end;
/
</code></pre>
<h2>One liners</h2>
<h3>Grants</h3>
<pre><code class="language-sql">SELECT 'GRANT ' || privilege || ' ON &quot;' || GRANTOR ||'&quot;.&quot;' || TABLE_NAME || 
       '&quot; TO &quot;' || GRANTEE || '&quot;;' 
FROM dba_tab_privs 
WHERE grantor = 'FOO'
AND grantee = 'BAR'
;
</code></pre>
<h3>Recreating synonyms as sys</h3>
<pre><code class="language-sql">select 'CREATE OR REPLACE SYNONYM &quot;' || OWNER || '&quot;.&quot;' || SYNONYM_NAME || 
       '&quot; FOR &quot;' || TABLE_OWNER || '&quot;.&quot;' || TABLE_NAME || '&quot;;' 
from dba_synonyms 
where table_owner = 'FOO';
</code></pre>

    </article>
    <br /><br />
    <a href="https://twitter.com/share" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </main>
  <footer>
  <hr>
  <p>
    <a href="/license/">CC BY-SA 4.0 / MIT</a>
    -
    <a href="https://github.com/cobalt-org/cobalt.rs">Built with Cobalt</a>
  </p>
  <br>
</footer>

</body>
</html>
